name: NestJS API CI

on:
  push:
    branches: [hiepnh]
  # pull_request:
  #   branches: [main]

jobs:
  release:
    if: contains(github.event.head_commit.message, 'publish ci')
    runs-on: self-hosted  # ðŸ‘‰ must use self-hosted

    steps:
      - uses: actions/checkout@v5

      - name: Restore .env.production from GitHub Secret
        run: |
          cat <<'EOF' > .env.production
          ${{ secrets.ENV_PRODUCTION }}
          EOF
          echo "âœ… Restored .env.production"


      # <database-document-block>
      - name: Run e2e tests for NestJS with Mongoose
        id: document
        # run: docker compose -f docker-compose.document.ci.yaml --env-file .env.production -p authen-ci up --build --exit-code-from api
        run: docker compose -f docker-compose.document.ci.yaml --env-file .env.production -p authen-ci up --build -d # --exit-code-from api

      - name: Run tests
        run: docker ps  # Check running containers

      - name: Show API Log
        run: docker logs -f authen-ci-api-1

      - name: Copy prod.log from container to host
        if: ${{ failure() && steps.document.conclusion == 'failure' }}
        run: docker cp authen-ci-api-1:/usr/src/app/prod.log .
      # </database-document-block>

      - name: Upload prod.log to artifacts for debugging
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: prod-logs
          path: prod.log

      # config trong https://github.com/vtconline/goPlaySDK-IOS/settings/secrets/actions
      # get telegram token from https://t.me/BotFather
      # get chat id from https://api.telegram.org/bot<YOUR_BOT_TOKEN>/getUpdates
      - name: Notify Telegram
        if: always()
        run: |
          STATUS="${{ job.status }}"
          MESSAGE="âœ…Status: $STATUS ${{ steps.bump_version.outputs.new_tag }} Repo: [${{ github.repository }}](https://github.com/${{ github.repository }})"

          echo "Message to be sent: $MESSAGE"
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="$MESSAGE" \
            -d parse_mode=Markdown    
